{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advisory Services Form</title>
    <link rel="stylesheet" href="{% static 'style.css' %}">
</head>

<body>
    <main class="main-content">
        <a href="{% url 'reports_dashboard' %}" style="text-decoration: none; color: #000;">
            <p style="margin-bottom: 20px;">&larr; Back to Dashboard</p>
        </a>
        <hr>
        <div class="form-header">
            <h2>Advisory Services Form</h2>
        </div>

        {% if messages %}
            <div class="messages">
                {% for message in messages %}
                    <div class="message {{ message.tags }}">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}

        <form class="main-form" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            {{ form.lunitid.as_hidden }}
            {{ form.collabagenciesid.as_hidden }}
            {{ form.clientsid.as_hidden }}
            {{ form.adservoverall.as_hidden }}
            {{ form.adservtimeliness.as_hidden }}
            {{ form.estexsourcefund.as_hidden }}
            {{ form.partship.as_hidden }}
            
            <!-- Partnership Selector for Auto-Population -->
            <div class="form-section">
                <div class="form-group">
                    <label for="partnership_selector">Auto-Populate from Partnership (Optional)</label>
                    <select id="partnership_selector" name="partnership_selector">
                        <option value="">-- Select a Partnership to Auto-Fill --</option>
                        {% for partnership in available_partnerships %}
                            <option value="{{ partnership.partship_id }}" {% if partnership.partship_id|stringformat:"s" == partnership_id %}selected{% endif %}>
                                Partnership {{ partnership.partship_id }} - {{ partnership.partagency.nameagen|default:"No Agency" }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="form-section">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="number">Advisory Services No.</label>
                        <input type="number" id="number" name="number" placeholder="Enter Advisory Services Number">
                    </div>
                    <div class="form-group">
                        <label for="code">Code</label>
                        <input type="text" id="code" name="code" placeholder="Enter Code (c/o Extension Services)">
                    </div>
                </div>
            </div>
            
            <!-- Lead Unit Sub-fields -->
            <div class="form-section">
                <div class="sub-field-group">
                    <h4>Lead Unit Information</h4>
                    <div class="sub-field-row">
                        <div class="form-group">
                            <label for="lunit_department">Department</label>
                            <input type="text" id="lunit_department" name="lunit_department" placeholder="Enter department name">
                        </div>
                        <div class="form-group">
                            <label for="lunit_contper">Contact Person</label>
                            <input type="text" id="lunit_contper" name="lunit_contper" placeholder="Enter contact person">
                        </div>
                        <div class="form-group">
                            <label for="lunit_continf">Contact Information</label>
                            <input type="text" id="lunit_continf" name="lunit_continf" placeholder="Enter contact information">
                        </div>
                    </div>
                </div>
            </div>  

            <div class="form-section">
                <div class="form-group">
                    <label for="curricoff">Curricular Offering</label>
                    <input type="text" id="curricoff" name="curricoff" placeholder="Enter Curriculum Offering">
                </div>
            </div>

            <div class="form-section">
                <!-- Collaborating Agencies Sub-fields -->
                <div class="sub-field-group">
                    <h4>Collaborating Agency Information</h4>
                    <div class="sub-field-row">
                        <div class="form-group">
                            <label for="collab_name">Agency Name</label>
                            <input type="text" id="collab_name" name="collab_name" placeholder="Enter collaborating agency name">
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <!-- Clients Sub-fields -->
                <div class="sub-field-group">
                    <h4>Client/s Information</h4>
                    <div class="sub-field-row">
                        <div class="form-group">
                            <label for="client_name">Name</label>
                            <textarea id="client_name" name="client_name" placeholder="Enter Name" rows="2"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="client_organization">Organization</label>
                            <textarea id="client_organization" name="client_organization" placeholder="Enter Organization" rows="2"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="client_number">Number/Email</label>
                            <input type="text" id="client_number" name="client_number" placeholder="Enter client number or email">
                        </div>
                        <div class="form-group">
                            <label for="client_sex">Sex</label>
                            <textarea id="client_sex" name="client_sex" placeholder="Enter sex (Male, Female)" rows="2"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="client_categ">Category</label>
                            <textarea id="client_categ" name="client_categ" placeholder="Enter Category (Student, Farmer, Fisherfolk, Others)" rows="2"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="projno">Project No.</label>
                        <input type="number" id="projno" name="projno" placeholder="Enter Project Number">
                    </div>
                </div>
            </div>

            <div class="form-section">
                <div class="form-group full-width">
                    <label for="adservprov">Advisory Services Provided</label>
                    <textarea id="adservprov" name="adservprov" placeholder="Technical assistance, consultation, resource person, Others" rows="3"></textarea>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="incldates">Inclusive Dates</label>
                        <textarea id="incldates" name="incldates" placeholder="Enter Inclusive Dates" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="venue">Venue</label>
                        <textarea id="venue" name="venue" placeholder="Enter Venue" rows="2"></textarea>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <!-- Overall Rating Sub-fields -->
                <div class="sub-field-group">
                    <h4>Overall Rating (1-5 Scale)</h4>
                    <div class="sub-field-row">
                        <div class="form-group">
                            <label for="overall_one">Rating 1</label>
                            <input type="number" id="overall_one" name="overall_one" placeholder="Enter count for rating 1">
                        </div>
                        <div class="form-group">
                            <label for="overall_two">Rating 2</label>
                            <input type="number" id="overall_two" name="overall_two" placeholder="Enter count for rating 2">
                        </div>
                        <div class="form-group">
                            <label for="overall_three">Rating 3</label>
                            <input type="number" id="overall_three" name="overall_three" placeholder="Enter count for rating 3">
                        </div>
                        <div class="form-group">
                            <label for="overall_four">Rating 4</label>
                            <input type="number" id="overall_four" name="overall_four" placeholder="Enter count for rating 4">
                        </div>
                        <div class="form-group">
                            <label for="overall_five">Rating 5</label>
                            <input type="number" id="overall_five" name="overall_five" placeholder="Enter count for rating 5">
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <!-- Timeliness Rating Sub-fields -->
                <div class="sub-field-group">
                    <h4>Timeliness Rating (1-5 Scale)</h4>
                    <div class="sub-field-row">
                        <div class="form-group">
                            <label for="timeliness_one">Rating 1</label>
                            <input type="number" id="timeliness_one" name="timeliness_one" placeholder="Enter count for rating 1">
                        </div>
                        <div class="form-group">
                            <label for="timeliness_two">Rating 2</label>
                            <input type="number" id="timeliness_two" name="timeliness_two" placeholder="Enter count for rating 2">
                        </div>
                        <div class="form-group">
                            <label for="timeliness_three">Rating 3</label>
                            <input type="number" id="timeliness_three" name="timeliness_three" placeholder="Enter count for rating 3">
                        </div>
                        <div class="form-group">
                            <label for="timeliness_four">Rating 4</label>
                            <input type="number" id="timeliness_four" name="timeliness_four" placeholder="Enter count for rating 4">
                        </div>
                        <div class="form-group">
                            <label for="timeliness_five">Rating 5</label>
                            <input type="number" id="timeliness_five" name="timeliness_five" placeholder="Enter count for rating 5">
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="totaladservreqrespond">Total Number of Requests Responded (Overall)</label>
                        <input type="number" id="totaladservreqrespond" name="totaladservreqrespond" placeholder="Auto-calculated from overall ratings" readonly>
                    </div>

                    <div class="form-group">
                        <label for="totaladservreq">Total Number of Client Requests (Timeliness)</label>
                        <input type="number" id="totaladservreq" name="totaladservreq" placeholder="Auto-calculated from timeliness ratings" readonly>
                    </div>
                    
                </div>
            </div>

            <div class="form-section">
                <!-- Estimated Expenses and Source of Fund Sub-fields -->
                <div class="sub-field-group">
                    <h4>Estimated Expenses and Source of Fund</h4>
                    <div class="sub-field-row">
                        <div class="form-group">
                            <label for="fund_amntchcvsu">Amount Charged to CVSU</label>
                            <input type="number" id="fund_amntchcvsu" name="fund_amntchcvsu" placeholder="Enter amount charged to CVSU">
                        </div>
                        <div class="form-group">
                            <label for="fund_amntchpartagency">Amount Charged to Partner Agency</label>
                            <input type="number" id="fund_amntchpartagency" name="fund_amntchpartagency" placeholder="Enter amount charged to partner agency">
                        </div>
                        <div class="form-group">
                            <label for="fund_partagencyname">Partner Agency Name</label>
                            <input type="text" id="fund_partagencyname" name="fund_partagencyname" placeholder="Enter partner agency name">
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="sdgnum">SDG Number</label>
                        <input type="text" id="sdgnum" name="sdgnum" placeholder="Enter SDG Number">
                    </div>
                    <div class="form-group">
                        <label for="themarea">Thematic Area</label>
                        <input type="text" id="themarea" name="themarea" placeholder="Enter Thematic Area">
                    </div>
                </div>
            </div>





            <div class="form-section">
                <div class="form-group full-width">
                    <label for="remarks">Remarks</label>
                    <textarea id="remarks" name="remarks" placeholder="Enter remarks" rows="3"></textarea>
                </div>
            </div>

            <div class="form-section">
                <h3>File Uploads</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="files">Files (Max 10)</label>
                        <input type="file" id="files" name="files" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.csv,.zip,.rar,.7z" onchange="handleFileSelect(this, 'file-preview')">
                        <div id="file-preview" class="file-preview"></div>
                    </div>
                    <div class="form-group">
                        <label for="images">Images (Max 10)</label>
                        <input type="file" id="images" name="images" multiple accept=".jpg,.jpeg,.png,.gif,.bmp,.webp,.svg" onchange="handleFileSelect(this, 'image-preview')">
                        <div id="image-preview" class="image-preview"></div>
                    </div>
                </div>
            </div>

            <!-- Advisory Services Records Section -->
            <div class="records-section">
                <div class="records-header">
                    <h3>Advisory Services Records</h3>
                    <div class="records-search">
                        <input type="text" id="advisory-search" placeholder="Search advisory services..." class="search-input-table">
                        <button type="button" class="btn-secondary" onclick="searchAdvisoryRecords()">Search</button>
                    </div>
                </div>
                <div class="records-table-container">
                    <table class="records-table" id="records-table">
                        <thead>
                            <tr>
                                <th>Advisory Services No.</th>
                                <th>Code</th>
                                <th>Department</th>
                                <th>Contact Person</th>
                                <th>Contact Information</th>
                                <th>Curriculum Offering</th>
                                <th>Agency Name</th>
                                <th>Client Name</th>
                                <th>Client Organization</th>
                                <th>Client Sex</th>
                                <th>Client Category</th>
                                <th>Client Number/Email</th>
                                <th>Project No.</th>
                                <th>Advisory Services Provided</th>
                                <th>Inclusive Dates</th>
                                <th>Venue</th>
                                <th>Overall Rating 1</th>
                                <th>Overall Rating 2</th>
                                <th>Overall Rating 3</th>
                                <th>Overall Rating 4</th>
                                <th>Overall Rating 5</th>
                                <th>Timeliness Rating 1</th>
                                <th>Timeliness Rating 2</th>
                                <th>Timeliness Rating 3</th>
                                <th>Timeliness Rating 4</th>
                                <th>Timeliness Rating 5</th>
                                <th>Total Requests</th>
                                <th>Total Responded</th>
                                <th>Amount CVSU</th>
                                <th>Amount Partner</th>
                                <th>Partner Agency Name</th>
                                <th>SDG Number</th>
                                <th>Thematic Area</th>

                                <th>Remarks</th>
                            </tr>
                        </thead>
                        <tbody id="advisory-records">
                            {% for service in advisory_services %}
                            <tr>
                                <td>{{ service.number|default:'-' }}</td>
                                <td>{{ service.code|default:'-' }}</td>
                                <td>{{ service.lunitid.department|default:'-' }}</td>
                                <td>{{ service.lunitid.contper|default:'-' }}</td>
                                <td>{{ service.lunitid.continf|default:'-' }}</td>
                                <td>{{ service.curricoff|default:'-' }}</td>
                                <td>{{ service.collabagenciesid.nameagen|default:'-' }}</td>
                                <td>{{ service.clientsid.name|default:'-' }}</td>
                                <td>{{ service.clientsid.organization|default:'-' }}</td>
                                <td>{{ service.clientsid.sex|default:'-' }}</td>
                                <td>{{ service.clientsid.categ|default:'-' }}</td>
                                <td>{{ service.clientsid.number|default:'-' }}</td>
                                <td>{{ service.projno.project_no|default:'-' }}</td>
                                <td>{{ service.adservprov|default:'-' }}</td>
                                <td>{{ service.incldates|default:'-' }}</td>
                                <td>{{ service.venue|default:'-' }}</td>
                                <td>{{ service.adservoverall.one|default:'-' }}</td>
                                <td>{{ service.adservoverall.two|default:'-' }}</td>
                                <td>{{ service.adservoverall.three|default:'-' }}</td>
                                <td>{{ service.adservoverall.four|default:'-' }}</td>
                                <td>{{ service.adservoverall.five|default:'-' }}</td>
                                <td>{{ service.adservtimeliness.one|default:'-' }}</td>
                                <td>{{ service.adservtimeliness.two|default:'-' }}</td>
                                <td>{{ service.adservtimeliness.three|default:'-' }}</td>
                                <td>{{ service.adservtimeliness.four|default:'-' }}</td>
                                <td>{{ service.adservtimeliness.five|default:'-' }}</td>
                                <td>{{ service.totaladservreq|default:'-' }}</td>
                                <td>{{ service.totaladservreqrespond|default:'-' }}</td>
                                <td>{{ service.estexsourcefund.amntchcvsu|default:'-' }}</td>
                                <td>{{ service.estexsourcefund.amntchpartagency|default:'-' }}</td>
                                <td>{{ service.estexsourcefund.partagencyname|default:'-' }}</td>
                                <td>{{ service.sdgnum|default:'-' }}</td>
                                <td>{{ service.themarea|default:'-' }}</td>
                                <td>{{ service.remarks|default:'-' }}</td>
                            </tr>
                            {% empty %}
                            <tr>

                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="form-actions">
                <a href="{% url 'export_advisory_services' %}" class="btn-export">Export CSV</a>
                <button type="submit" class="btn-primary">Save Advisory Service</button>
                <button type="reset" class="btn-secondary">Reset Form</button>
                <a href="{% url 'dashboard' %}" class="btn-secondary">Cancel</a>
            </div>
        </form>
    </main>

    <script>
        // File handling functions
        let accumulatedFiles = {};
        let accumulatedImages = {};
        
        function handleFileSelect(input, previewId) {
            const preview = document.getElementById(previewId);
            const newFiles = Array.from(input.files);
            const isImage = previewId.includes('image');
            const maxFiles = 10;
            
            // Get existing accumulated files
            let existingFiles = isImage ? (accumulatedImages[previewId] || []) : (accumulatedFiles[previewId] || []);
            
            // Combine existing and new files
            const allFiles = [...existingFiles, ...newFiles];
            
            if (allFiles.length > maxFiles) {
                alert(`Maximum ${maxFiles} files allowed. You have ${existingFiles.length} files already.`);
                input.value = '';
                return;
            }
            
            // Store accumulated files
            if (isImage) {
                accumulatedImages[previewId] = allFiles;
            } else {
                accumulatedFiles[previewId] = allFiles;
            }
            
            // Update the input files
            const dt = new DataTransfer();
            allFiles.forEach(file => dt.items.add(file));
            input.files = dt.files;
            
            // Clear and rebuild preview
            preview.innerHTML = '';
            
            allFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = isImage ? 'image-item' : 'file-item';
                
                // Add file type icon
                const fileIcon = document.createElement('span');
                fileIcon.className = 'file-icon';
                if (isImage) {
                    fileIcon.innerHTML = '🖼️';
                    fileIcon.style.color = '#4CAF50';
                } else {
                    const ext = file.name.split('.').pop().toLowerCase();
                    if (['pdf'].includes(ext)) {
                        fileIcon.innerHTML = '📄';
                        fileIcon.style.color = '#f44336';
                    } else if (['doc', 'docx'].includes(ext)) {
                        fileIcon.innerHTML = '📄';
                        fileIcon.style.color = '#2196F3';
                    } else if (['xls', 'xlsx'].includes(ext)) {
                        fileIcon.innerHTML = '📈';
                        fileIcon.style.color = '#4CAF50';
                    } else {
                        fileIcon.innerHTML = '📁';
                        fileIcon.style.color = '#FF9800';
                    }
                }
                
                const fileName = document.createElement('span');
                fileName.className = 'file-name';
                fileName.textContent = file.name;
                
                const fileSize = document.createElement('span');
                fileSize.className = 'file-size';
                fileSize.textContent = `(${(file.size / 1024).toFixed(1)} KB)`;
                
                const removeBtn = document.createElement('button');
                removeBtn.innerHTML = '×';
                removeBtn.className = 'remove-btn';
                removeBtn.type = 'button';
                removeBtn.onclick = function() {
                    removeFile(input, index, previewId);
                };
                
                fileItem.appendChild(fileIcon);
                fileItem.appendChild(fileName);
                fileItem.appendChild(fileSize);
                fileItem.appendChild(removeBtn);
                preview.appendChild(fileItem);
            });
        }
        
        function removeFile(input, index, previewId) {
            const isImage = previewId.includes('image');
            
            // Remove from accumulated storage
            if (isImage) {
                accumulatedImages[previewId] = accumulatedImages[previewId].filter((_, i) => i !== index);
            } else {
                accumulatedFiles[previewId] = accumulatedFiles[previewId].filter((_, i) => i !== index);
            }
            
            // Update input files
            const dt = new DataTransfer();
            const remainingFiles = isImage ? accumulatedImages[previewId] : accumulatedFiles[previewId];
            remainingFiles.forEach(file => dt.items.add(file));
            input.files = dt.files;
            
            // Rebuild preview
            const preview = document.getElementById(previewId);
            preview.innerHTML = '';
            
            remainingFiles.forEach((file, i) => {
                const fileItem = document.createElement('div');
                fileItem.className = isImage ? 'image-item' : 'file-item';
                
                // Add file type icon
                const fileIcon = document.createElement('span');
                fileIcon.className = 'file-icon';
                if (isImage) {
                    fileIcon.innerHTML = '🖼️';
                    fileIcon.style.color = '#4CAF50';
                } else {
                    const ext = file.name.split('.').pop().toLowerCase();
                    if (['pdf'].includes(ext)) {
                        fileIcon.innerHTML = '📄';
                        fileIcon.style.color = '#f44336';
                    } else if (['doc', 'docx'].includes(ext)) {
                        fileIcon.innerHTML = '📄';
                        fileIcon.style.color = '#2196F3';
                    } else if (['xls', 'xlsx'].includes(ext)) {
                        fileIcon.innerHTML = '📈';
                        fileIcon.style.color = '#4CAF50';
                    } else {
                        fileIcon.innerHTML = '📁';
                        fileIcon.style.color = '#FF9800';
                    }
                }
                
                const fileName = document.createElement('span');
                fileName.className = 'file-name';
                fileName.textContent = file.name;
                
                const fileSize = document.createElement('span');
                fileSize.className = 'file-size';
                fileSize.textContent = `(${(file.size / 1024).toFixed(1)} KB)`;
                
                const removeBtn = document.createElement('button');
                removeBtn.innerHTML = '×';
                removeBtn.className = 'remove-btn';
                removeBtn.type = 'button';
                removeBtn.onclick = function() {
                    removeFile(input, i, previewId);
                };
                
                fileItem.appendChild(fileIcon);
                fileItem.appendChild(fileName);
                fileItem.appendChild(fileSize);
                fileItem.appendChild(removeBtn);
                preview.appendChild(fileItem);
            });
        }

        // Search functionality for advisory services records
        function searchAdvisoryRecords() {
            const searchTerm = document.getElementById('advisory-search').value.toLowerCase();
            const rows = document.querySelectorAll('#advisory-records tr');
            
            rows.forEach(function(row) {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        // Search on Enter key
        document.getElementById('advisory-search').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                searchAdvisoryRecords();
            }
        });

        // Real-time search
        document.getElementById('advisory-search').addEventListener('input', searchAdvisoryRecords);

        // Debug: Log all form elements on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Advisory Services Form loaded');
            console.log('Form sections found:', document.querySelectorAll('.form-section').length);
            console.log('Form groups found:', document.querySelectorAll('.form-group').length);
            console.log('Input fields found:', document.querySelectorAll('input').length);
            console.log('Textarea fields found:', document.querySelectorAll('textarea').length);
            
            // Check if specific fields exist
            const criticalFields = ['number', 'code', 'categid', 'lunit_department', 'curricoff', 'collab_name'];
            criticalFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                console.log(`Field ${fieldId}:`, field ? 'Found' : 'Missing');
            });
            
            // Auto-populate from partnership
            const partnershipSelect = document.getElementById('partnership_selector');

            if (partnershipSelect) {
                partnershipSelect.addEventListener('change', function() {
                    const partnershipId = this.value;

                    if (partnershipId) {
                        const url = `/partnerships/api/partnership/${partnershipId}/`;

                        fetch(url)
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('Network response was not ok');
                                }
                                return response.json();
                            })
                            .then(data => {
                                console.log('Auto-populating advisory form with data:', data);

                                // Populate base fields
                                if (data.code) {
                                    document.getElementById('code').value = data.code;
                                }
                                if (data.curricoff) {
                                    document.getElementById('curricoff').value = data.curricoff;
                                }
                                
                                // Populate lead unit fields
                                if (data.lunit_department) {
                                    document.getElementById('lunit_department').value = data.lunit_department;
                                }
                                if (data.lunit_contper) {
                                    document.getElementById('lunit_contper').value = data.lunit_contper;
                                }
                                if (data.lunit_continf) {
                                    document.getElementById('lunit_continf').value = data.lunit_continf;
                                }
                                
                                // Populate collaborating agency fields
                                if (data.collab_name) {
                                    document.getElementById('collab_name').value = data.collab_name;
                                }
                                
                                // Populate SDG and Thematic Area
                                if (data.sdgnum) {
                                    document.getElementById('sdgnum').value = data.sdgnum;
                                }
                                if (data.themarea) {
                                    document.getElementById('themarea').value = data.themarea;
                                }
                                
                                alert('Form auto-populated with partnership data!');
                            })
                            .catch(error => {
                                console.error('Error auto-populating advisory form:', error);
                                alert('Error loading partnership data. Please try again.');
                            });
                    } else {
                        clearAdvisoryForm();
                    }
                });
            }
        });
        
        function clearAdvisoryForm() {
            const fieldIds = [
                'code', 'curricoff',
                'lunit_department', 'lunit_contper', 'lunit_continf',
                'collab_name',
                'sdgnum', 'themarea'
            ];
            
            fieldIds.forEach(id => {
                const field = document.getElementById(id);
                if (field) field.value = '';
            });
        }
        
        // Auto-calculate totals from rating inputs
        function calculateTotals() {
            // Calculate total from timeliness ratings
            const timelinessInputs = ['timeliness_one', 'timeliness_two', 'timeliness_three', 'timeliness_four', 'timeliness_five'];
            let timelinessTotal = 0;
            timelinessInputs.forEach(id => {
                const value = parseInt(document.getElementById(id).value) || 0;
                timelinessTotal += value;
            });
            document.getElementById('totaladservreq').value = timelinessTotal;
            
            // Calculate total from overall ratings
            const overallInputs = ['overall_one', 'overall_two', 'overall_three', 'overall_four', 'overall_five'];
            let overallTotal = 0;
            overallInputs.forEach(id => {
                const value = parseInt(document.getElementById(id).value) || 0;
                overallTotal += value;
            });
            document.getElementById('totaladservreqrespond').value = overallTotal;
        }
        
        // Add event listeners for auto-calculation
        document.addEventListener('DOMContentLoaded', function() {
            const ratingInputs = [
                'timeliness_one', 'timeliness_two', 'timeliness_three', 'timeliness_four', 'timeliness_five',
                'overall_one', 'overall_two', 'overall_three', 'overall_four', 'overall_five'
            ];
            
            ratingInputs.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', calculateTotals);
                }
            });
        });
    </script>
    
    <!-- Debug CSS to ensure all fields are visible -->
    <style>
        /* Ensure all form elements are visible */
        .form-section {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        .form-group {
            display: flex !important;
            flex-direction: column !important;
            visibility: visible !important;
            opacity: 1 !important;
            margin-bottom: 1rem !important;
        }
        
        .sub-field-group {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        .sub-field-row {
            display: grid !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        input, textarea, select {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            width: 100% !important;
            min-height: 40px !important;
        }
        
        label {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            margin-bottom: 0.5rem !important;
        }
        
        /* Force visibility of specific sections that might be hidden */
        .form-section:nth-child(n) {
            display: block !important;
        }
        
        /* Ensure grid layouts work properly */
        .form-grid {
            display: grid !important;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)) !important;
            gap: 1.5rem !important;
        }
    </style>
</body>
</html>